<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://kit.fontawesome.com/9d0690b173.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>POP 14</title>
</head>
<style>
    *{
        margin: 0;
        position: relative;
    }
    html,body{height:100%;margin:0;}
    body{
      background: url('./src/308bfcf37eeafbe3.png') center center / auto 100% no-repeat; 
    }
    #head{
        width: 100%;
        height: 100%;
        position: absolute;
        display: flex;
        align-items: center;
        flex-direction: column;
    }
    h1{
        text-shadow: -1px -1px 0 #efe4d1,
              1px -1px 0 #efe4d1,
              -1px 1px 0 #efe4d1,
              1px 1px 0 #efe4d1;
    }
    #look{
      width: 100%;
      height: 100%;
      background-color: #fff;
      position: absolute;
      display: none;
      align-items: center;
      flex-direction: column;
      justify-content: center;
      
    }
    #look img{
      
      width: 50%;
    }
    #cross{
      position: absolute; 
      top: 20px;
      right: 20px;
      cursor: pointer;
    }
    .trophy{
      position: absolute;
      right: 10px;
      top: 10px;
      z-index: 999;
    }
    #app{
      width: 100%;
      height: 100%;
    }
  </style>
<body>
  <div id="app" >
    <div id="head" @click="clickNum">
      <h1 style="margin-top: 10px;">POP 14</h1>
      <h1>{{formatWithCommas(count_number)}}</h1>
      
    </div>
 
    <button type="button" class="btn btn-primary trophy" style="background-color: #cbb365;border: none;"  data-bs-toggle="modal" data-bs-target="#exampleModal">
      <i class="fa-solid fa-trophy"></i>
    </button>


    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="m-0 p-0">排行榜</h3>
            
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            
            <div class="input-group mb-3">
              <span class="input-group-text" id="inputGroup-sizing-default">次數：{{formatNumber(count_number)}}</span>
              <input type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-default" v-model="user_name" placeholder="輸入暱稱">
              <button class="btn btn-secondary" type="button" id="button-addon2" @click="insertCount">送出紀錄</button>
            </div>
            
            
            
            <table class="table mt-3">
              <thead>
                <tr>
                  <th scope="col" style="width: 10%;word-wrap: break-all;">#</th>
                  <th scope="col" style="width: 60%;word-wrap: break-word;overflow-wrap: break-word;word-break: break-all; ">暱稱</th>
                  <th scope="col" style="width: 30%;word-wrap: break-word;overflow-wrap: break-word;word-break: break-all; "><button type="button" class="btn btn btn-outline-dark" @click="forNum = !forNum">切換顯示方式</button></th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(i,index) in articles.slice(0,10)" :key="i.id">
                  <th scope="row">{{ index+1 }}</th>
                  <td style="width: 60%;word-wrap: break-word;overflow-wrap: break-word;word-break: break-all; ">{{i.name}}</td>
                  <td style="width: 30%;word-wrap: break-word;overflow-wrap: break-word;word-break: break-all; " v-if="forNum">{{formatWithCommas(i.counter)}}</td>
                  <td style="width: 30%;word-wrap: break-word;overflow-wrap: break-word;word-break: break-all; " v-else>{{formatNumber(i.counter)}}</td>

                </tr>
                
              </tbody>
            </table>

            <div class="mt-3">
              
              <div class="alert alert-warning" role="alert">
                BUG修復時間不一定，我在玩寶ZA，好玩一直玩
              </div>
              <img src="./src/export202510221228359330.png" alt="" style="width: 100%;">
            </div>
            
          </div>
          
        </div>
      </div>
    </div>
  </div>
    
    <!--
    <div id="look">
        <div style="margin-bottom: 20px;">你已經點了<sapn id="howmany"></sapn>下，看一下我寶貝</div>
        <img src="./src/5eb332-bfecgz3l97am2usjtq16empatkdg0b8u-1.jpg" alt="">
        <div id="cross">X</div>
    </div>
    -->
</body>
<script>
    const count = document.getElementById('head');
    const countr = document.getElementById('count');
    const howmany = document.getElementById('howmany');
    const supabaseUrl = 'https://rvntujioqkontqqjhxdb.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2bnR1amlvcWtvbnRxcWpoeGRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MjkwNTMsImV4cCI6MjA3NTUwNTA1M30.YGPpQFss05qu3YmmHvnmfJycmhbQDTSKlzDz25Gbg6c';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    
    
    (function(){
      const BG1 = './src/308bfcf37eeafbe3.png';
      const BG2 = './src/3956ebb3bcb4069c.png';
      const audioSrc = './src/popcat.mp3';
      
      const preload = new Image();
      preload.src = BG2;

      const sound = new Audio(audioSrc);
      sound.preload = "auto";
  
      let t = null;
      document.body.addEventListener('click', () => {
        
        if (t) clearTimeout(t);
  
        document.body.style.backgroundImage = `url("${BG2}")`;
        
        sound.currentTime = 0;
        sound.play().catch(e => {
      // 有些瀏覽器限制沒互動就不能自動播放
          console.warn("音效播放失敗：", e);
        });
  
        t = setTimeout(() => {
          document.body.style.backgroundImage = `url("${BG1}")`;
          t = null;
        }, 100); // 1 秒後換回
      });
    })();

    new Vue({
      el: '#app',
      data: {
        articles: [],
        count_number: 0,
        user_name: "",
        forNum: false,
      },
      async mounted() {
    // === 讀取 Supabase 資料 ===
        try {
          const { data, error } = await supabase
            .from('pop14')
            .select('*')
            .order('counter', { ascending: false })
            .order('id', { ascending: true })

            if (error) throw error
            this.articles = data


        } catch (err) {
          console.error('Supabase select failed:', err)
        }
      },
      methods: {
        formatNumber(n) {
          if (n >= 1_000_000_000) {
            const val = Math.floor(n / 100_000_000) / 10; // ← 取到一位小數但不進位
            return val.toString().replace(/\.0$/, '') + 'B';
          }
          if (n >= 1_000_000) {
            const val = Math.floor(n / 100_000) / 10;
            return val.toString().replace(/\.0$/, '') + 'M';
          }
          if (n >= 1_000) {
            const val = Math.floor(n / 100) / 10;
            return val.toString().replace(/\.0$/, '') + 'k';
          }
          return n.toString();
        },
        formatWithCommas(n) {
          if (n == null || n === '') return '';
            const num = Number(n);
          if (!Number.isFinite(num)) return String(n); // 不是數字就原樣回傳
            return new Intl.NumberFormat('en-US', {
              maximumFractionDigits: 20, // 只影響顯示位數，不會改變整數
            }).format(num);
        },
        clickNum(){
          this.count_number += 1;
        },
        async insertCount() {

          if(this.count_number == 0){
            alert("根本沒按")
          }
          else if(this.user_name == 0){
            alert("根本沒輸入名字")
          }
          else{
            const { data, error } = await supabase
            .from('pop14')        // 表格名稱
            .insert([
              { name: this.user_name, counter: this.count_number }   // 欄位名稱要對！
            ]);

            if (error) {
              console.error("插入失敗", error);
            } else {
              console.log("成功插入：", data);
            }
            location.reload(); 
          }
  }
      },
      computed: {
        
      }
    })
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

</html>